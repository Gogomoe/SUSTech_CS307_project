_12307.train_search = function() {
    var dhxWindow = new dhx.Window({
        title: "国内火车查询",
        modal: false,
        footer: false,
        closable: false,
        resizable: true,
        movable: true,
        closable: true,
        width: 460, 
        height: 480
    });

    var tabbar = new dhx.Tabbar(null, {
        mode: "top",
        css: "dhx_widget--bordered",
        views:[
            { tab: "按城市查找", id: "byKeyword" },
            { tab: "按车次查找", id: "byTrainNo"}
        ]
    });

    var form_by_keyword = new dhx.Form(null, {
        css: "dhx_widget--bordered",
        rows: [
            {
                type: "input",
                name: "from",
                gravity: false,
                label: "出发地",
                icon: "",
                placeholder: "城市名或站名",
                value: "深圳",
                required: true
            },
            {
                type: "input",
                name: "to",
                gravity: false,
                label: "到达地",
                placeholder: "城市名或站名",
                value: "上海",
                required: true
            },
            {
                type: "datepicker",
                name: "date",
                gravity: true,
                value: "2020-05-01",
                dateFormat: "%Y-%m-%d",
                label: "出发时间"
            },
            {
                type: "button",
                name: "search",
                gravity: true,
                full: true,
                value: "查询",
                size: "medium",
                view: "flat",
                color: "primary",
            }
        ]
    });

    var form_by_trainno = new dhx.Form(null, {
        css: "dhx_widget--bordered",
        rows: [
            {
                type: "input",
                name: "trainno",
                gravity: false,
                label: "车次",
                icon: "",
                placeholder: "T6",
                required: true
            },
            {
                type: "datepicker",
                name: "date",
                gravity: false,
                value: "2020-05-01",
                dateFormat: "%Y-%m-%d",
                label: "出发时间"
            },
            {
                type: "button",
                name: "search",
                gravity: false,
                full: true,
                value: "查询",
                size: "medium",
                view: "flat",
                color: "primary",
            }
        ]
    });

    form_by_keyword.events.on("ButtonClick", function(id,e) {
        _12307.api.search_by_keyword(form_by_keyword.getValue(), function(data) {
            _12307.train_info(data);
        });
    });

    form_by_trainno.events.on("ButtonClick", function(id,e) {
        console.log(form_by_trainno.getValue());
    });

    tabbar.getCell("byKeyword").attach(form_by_keyword);
    tabbar.getCell("byTrainNo").attach(form_by_trainno);

    this.__init = function() {
        dhxWindow.attach(tabbar);
        dhxWindow.show();
    }

    this.__init();
}

_12307.train_info = function(api_data) {

    var dhxWindow = new dhx.Window({
        title: "查询结果",
        modal: false,
        header: true,
        footer: false,
        closable: true,
        resizable: true,
        movable: true,
        width: 1400,
        height: 800
    });

    var grid = new dhx.Grid("grid", {
        columns: [
            { id: "trainNo", header: [{ text: "车次" }] },
            { id: "type", header: [{ text: "列车类型" }] },
            { id: "departStation", header: [{ text: "出发站" }] },
            { id: "arriveStation", header: [{ text: "到达站" }] },
            { id: "departTime", header: [{ text: "出发时间" }] },
            { id: "arriveTime", header: [{ text: "到达时间" }] },
            { id: "durationTime", header: [{ text: "运行时间" }] },
            { id: "price2", header: [{ text: "二等座 / 硬座" }] },
            { id: "price1", header: [{ text: "一等座 / 软座" }] },
            { id: "priceh", header: [{ text: "软卧" }] },
            { id: "prices", header: [{ text: "硬卧" }] },
            { id: "operation", header: [{ text: "操作" }], htmlEnable: true, width: 64 }
        ],
        autoWidth: true,
        // data: dataset
    });

    var isFullScreen = false;
    var oldSize = null;
    var oldPos = null;

    this.__init = function(api_data) {
        var __seats_toString = function(seats, id) {
            if(seats[id]) {
                if(seats[id]["count"]>0) return String(seats[id]["price"]) + "￥";
                else return "暂无余票";
            } else return "";
        }

        var __datetime_toString = function(from_time, to_time, isDuration) {
            from = moment(from_time, moment.ISO_8601);
            if(!isDuration) from.hours(0).minutes(0).seconds(0);
            to = moment(to_time, moment.ISO_8601);
            diff = moment.utc( to.diff(from) );
            day = diff.date() - 1;

            if(day>=1) {
                if(isDuration) return "(" + day + "日) " + diff.format("HH时mm分");
                else return "(" + day + "日后) " + diff.format("HH:mm");
            } else {
                if(isDuration) return diff.format("HH时mm分");
                else return diff.format("HH:mm");
            }
        }

        var dataset = [];
        var arr = api_data["trains"];
        for(i=0; i<arr.length; ++i) {
            var entry = arr[i];
            var departTime = entry["depart_time"];
            var arriveTime = entry["arrive_time"];
            dataset.push({
                "trainNo": entry["train"]["static"]["code"],
                "departStation": entry["depart_station"]["name"],
                "arriveStation": entry["arrive_station"]["name"],
                "departTime": __datetime_toString(departTime, departTime, false),
                "arriveTime": __datetime_toString(departTime, arriveTime, false),
                "durationTime": __datetime_toString(departTime, arriveTime, true),
                "price2": __seats_toString(entry["seats"], "1"),
                "price1": __seats_toString(entry["seats"], "2"),
                "priceh": __seats_toString(entry["seats"], "3"),
                "prices": __seats_toString(entry["seats"], "4"),
                "type": entry["train"]["static"]["type"],
                "operation": "<div class='purchase-button'><span class='mdi mdi-shopping'></span>订票</div>",
                "originData": entry
            });
        }

        dhxWindow.header.data.add({ icon: "mdi mdi-fullscreen", id: "fullscreen" }, 2);
        dhxWindow.header.events.on("click", function (id) {
            if (id === "fullscreen") {
                if (isFullScreen) {
                    dhxWindow.setSize(oldSize.width, oldSize.height);
                    dhxWindow.setPosition(oldPos.left, oldPos.top);
                } else {
                    oldSize = dhxWindow.getSize();
                    oldPos = dhxWindow.getPosition();
                    dhxWindow.setFullScreen();
                }
                isFullScreen = !isFullScreen;
            }
        });

        grid.events.on("CellClick", function(row, column, e){
            if(column.id!="operation") {

            } else {
                if(_elpis.api.is_logged_in()) {
                    setTimeout(function() { _12307.train_order(row); }, 100);
                } else {
                    _elpis.loginform();
                }
            }
        });

        grid.data.parse(dataset);

        dhxWindow.show();
        dhxWindow.attach(grid);

    }

    this.__init(api_data);
}

// _12307.train(null);

_12307.train_order = function(row_data) {
    var dhxWindow = new dhx.Window({
        title: "订单",
        modal: false,
        footer: false,
        closable: false,
        resizable: true,
        movable: true,
        closable: true,
        width: 400, 
        height: 640
    });

    var seat_type = ["", "二等座 / 硬座", "一等座 / 软座", "硬卧", "软卧"];
    var seat_options = [];

    for(i=1; i<seat_type.length; ++i) {
        var seat = row_data["originData"]["seats"][String(i)];
        if(seat && seat.count>0) {
            seat_options.push({
                type: "radioButton",
                label: seat_type[i] + " [余票:" + seat.count + " 单价:" + seat.price + "￥]",
                labelInline: true,
                value: i
            });
        }
    }

    var form = new dhx.Form(null, {
        css: "dhx_widget--bordered",
        rows: [
            {
                type: "input",
                name: "departStation",
                gravity: false,
                label: "出发站",
                labelInline: true,
                icon: "",
                value: row_data["departStation"],
                readOnly: true,
                disabled: true
            },
            {
                type: "input",
                name: "arriveStation",
                gravity: false,
                label: "到达站",
                labelInline: true,
                value: row_data["arriveStation"],
                readOnly: true,
                disabled: true
            },
            {
                type: "datepicker",
                name: "date",
                gravity: false,
                value: row_data["originData"]["train"]["depart_date"],
                dateFormat: "%Y-%m-%d",
                label: "出发时间",
                labelInline: true,
                disabled: true
            },
            {
                type: "input",
                name: "phoneNumber",
                gravity: false,
                label: "手机号码",
                labelInline: true,
                placeholder: "有效11位手机号",
                required: true
            },
            {
                type: "radioGroup",
                name: "seat_type",
                id: "seat_type",
                disabled: false,
                required: true,
                gravity: false,
                options: {
                    padding: "5px",
                    rows: seat_options
                }
            },
            {
                type: "button",
                name: "addPassenger",
                id: "addPassenger",
                gravity: true,
                full: true,
                value: "添加同行人",
                size: "medium",
                view: "flat",
                color: "primary",
            },
            {
                type: "text",
                name: "price",
                id: "price",
                label: "价格",
                labelInline: true,
                gravity: false,                      
                value: "0￥"
            },
            {
                type: "button",
                name: "order",
                id: "order",
                gravity: false,
                full: true,
                value: "提交订单",
                size: "medium",
                view: "flat",
                color: "primary",
            }
        ]
    });

    var passengers = [];
    var update_price = function() {
        var seat = String(form.getItem("seat_type").getValue());
        if(seat) {
            var price = row_data["originData"]["seats"][seat]["price"] * passengers.length;
            form.getItem("price").setValue(String(price) + "￥");
        }
    }

    this.__init = function() {

        form.events.on("ButtonClick", function(id, e) {
            console.log(id);
            if(id == "addPassenger") {
                _12307.api.get_all_passenger(function(data) {
                    _12307.passenger(data, function(selected_items) {
                        passengers = selected_items;
                        update_price();
                    });
                }, _elpis.alert.__cb_show_err_msg);
            } else if(id == "order") {
                var seat = form.getItem("seat_type").getValue();
                var originData = row_data["originData"];
                dhxWindow.hide();
                _elpis.journal.__show_window();
                for(i=0; i<passengers.length; ++i) {
                    var p = passengers[i];
                    _12307.api.purchase_ticket({
                        "train": originData.train.id,
                        "seat": seat,
                        "from": originData.depart_station.id,
                        "to": originData.arrive_station.id,
                        "passenger": p["passenger_id"]
                    }, function() {
                        var name = p["passenger_name"];
                        return function() { _elpis.journal.__append_text( name + "的车票购买成功\n"); };
                    }(), function() {
                        var name = p["passenger_name"];
                        return function(err) { _elpis.journal.__append_text( name + "的车票购买失败，错误信息: " + JSON.stringify(err) + "\n"); };
                    }());
                }
            }
        });

        form.events.on("Change",function(name, new_value){
            update_price();
        });

        dhxWindow.attach(form);
        dhxWindow.show();
        dhxWindow.paint();
        
    }

    this.__init();
}